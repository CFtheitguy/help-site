<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Linear Desk — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root {
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937; --primary:#6ee7b7;
    }
    body { margin:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui, sans-serif; }
    .wrap{max-width:1200px; margin:28px auto; padding:0 16px; display:flex; gap:16px;}
    .list, .detail{flex:1; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; overflow:auto; max-height:90vh;}
    h1{margin:0 0 12px; font-size:20px}
    h2{margin:12px 0; font-size:16px; color:var(--muted)}
    .btn{background:#111827; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer}
    .btn:hover{background:#1f2937}
    input, textarea{width:100%; padding:8px; border-radius:8px; border:1px solid var(--border); background:#0b1730; color:var(--text)}
    table{width:100%; border-collapse:collapse}
    th,td{padding:6px; border-bottom:1px solid var(--border); text-align:left}
    tr:hover{background:#0a1428; cursor:pointer}
    .muted{color:var(--muted)}
    .message{border-bottom:1px solid var(--border); padding:8px 0}
    .meta{font-size:12px; color:var(--muted)}
    .attachments a{color:var(--primary); margin-right:10px}
    #loginBox{max-width:400px;margin:60px auto;text-align:center}
  </style>
</head>
<body>
<div id="loginBox" class="card" style="display:none;max-width:400px;margin:80px auto;padding:20px;">
  <h2>Staff Login</h2>
  <input id="pw" type="password" placeholder="Enter staff password"/>
  <div style="margin-top:10px;"><button id="btnLogin" class="btn">Login</button></div>
  <div id="loginMsg" class="muted" style="margin-top:10px;"></div>
</div>

<div id="dash" class="wrap" style="display:none;">
  <div class="list">
    <h1>Tickets</h1>
    <table id="tickets">
      <thead><tr><th>#</th><th>Title</th><th>Status</th><th>Updated</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="detail">
    <h1 id="ticket-title">Select a ticket</h1>
    <div id="conversation"></div>
    <div id="replyBox" style="display:none;">
      <h2>Reply to client</h2>
      <textarea id="reply-text" placeholder="Write your reply…"></textarea><br>
      <input type="file" id="reply-files" multiple><br><br>
      <button class="btn" onclick="sendReply()">Send reply</button>
    </div>
    <div id="noteBox" style="display:none;">
      <h2>Internal note</h2>
      <textarea id="note-text" placeholder="Internal only…"></textarea><br>
      <button class="btn" onclick="sendNote()">Add note</button>
    </div>
  </div>
</div>

<script>
const API = "https://api.help.linearit.co";
function $(id){return document.getElementById(id)}

async function checkAuth(){
  const r = await fetch(`${API}/admin/diag`, {credentials:"include"});
  if(r.status===401){ showLogin(); return; }
  const j = await r.json().catch(()=>({}));
  if(j.ok){ showDash(); loadTickets(); } else showLogin();
}
function showLogin(){ $("loginBox").style.display="block"; $("dash").style.display="none"; }
function showDash(){ $("loginBox").style.display="none"; $("dash").style.display="flex"; }

$("btnLogin").onclick = async ()=>{
  const pw = $("pw").value.trim();
  $("loginMsg").textContent="Logging in…";
  const r = await fetch(`${API}/admin/login`, {
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({password:pw}), credentials:"include"
  });
  const j = await r.json().catch(()=>({}));
  if(j.ok){ $("loginMsg").textContent="Success!"; setTimeout(()=>location.reload(),500); }
  else $("loginMsg").textContent="Unauthorized.";
};

async function loadTickets(){
  const tbody = $("tickets").querySelector("tbody");
  tbody.innerHTML="<tr><td colspan=4>Loading…</td></tr>";
  const r = await fetch(`${API}/admin/tickets`, {credentials:"include"});
  const j = await r.json().catch(()=>({}));
  tbody.innerHTML="";
  (j.items||[]).forEach(t=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${t.number}</td><td>${t.title||"(no title)"}</td>
                  <td>${(t.labels||[]).map(l=>l.name).join(", ")}</td>
                  <td>${new Date(t.updated_at||t.created_at).toLocaleString()}</td>`;
    tr.onclick=()=>loadTicket(t.number);
    tbody.appendChild(tr);
  });
}

async function loadTicket(id){
  $("ticket-title").innerText=`Ticket #${id}`;
  $("conversation").innerHTML="Loading...";
  $("replyBox").style.display="block";
  $("noteBox").style.display="block";
  const r=await fetch(`${API}/admin/tickets/${id}`,{credentials:"include"});
  const j=await r.json();
  const convo=$("conversation");
  convo.innerHTML="";
  const all=[{body:j.issue.body,user:j.issue.user.login,created_at:j.issue.created_at}].concat(j.comments||[]);
  all.forEach(m=>{
    const div=document.createElement("div"); div.className="message";
    div.innerHTML=`<div class="meta">${m.user?.login||"system"} — ${new Date(m.created_at).toLocaleString()}</div>`;
    let body=(m.body||"").replace(/\n/g,"<br>");
    body=body.replace(/https?:\/\/\S+\.(png|jpg|jpeg|gif|pdf|txt|zip|docx|xlsx|pptx)/gi,
      url=>`<div class="attachments"><a href="${url}" target="_blank">${url.split("/").pop()}</a></div>`);
    div.innerHTML+=`<div>${body}</div>`;
    convo.appendChild(div);
  });
  window.currentTicket=id;
}

async function sendReply(){
  const text=$("reply-text").value; if(!text) return alert("Type a reply");
  const fd=new FormData(); fd.append("text",text);
  const files=$("reply-files").files; for(let f of files) fd.append("files",f);
  const r=await fetch(`${API}/admin/tickets/${window.currentTicket}/reply`,{method:"POST",body:fd,credentials:"include"});
  const j=await r.json(); if(j.ok){$("reply-text").value="";$("reply-files").value=null;loadTicket(window.currentTicket);}
  else alert("Error: "+JSON.stringify(j));
}

async function sendNote(){
  const text=$("note-text").value; if(!text) return alert("Type a note");
  const r=await fetch(`${API}/admin/tickets/${window.currentTicket}/note`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text}),credentials:"include"});
  const j=await r.json(); if(j.ok){$("note-text").value="";loadTicket(window.currentTicket);}
  else alert("Error: "+JSON.stringify(j));
}

checkAuth();
</script>
</body>
</html>
